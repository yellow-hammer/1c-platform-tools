---
description: Правила для работы с DAP и onec-debug-adapter
globs: src/debug/**/*.ts
alwaysApply: false
---

# DAP и onec-debug-adapter

## Общие принципы

- Адаптер отладки (`onec-debug-adapter`) — **внешний бинарь**, не часть исходников расширения.
- В VSIX попадает **только** каталог `bin/onec-debug-adapter/` с уже опубликованным релизом.
- Исходный код адаптера живёт в отдельном репозитории `yellow-hammer/onec-debug-adapter` и собирается/упаковывается GitHub Actions там.

## Сборка и поставка адаптера

- Скрипт `scripts/build-onec-adapter.mjs`:
  - сначала пытается скачать готовый релиз с GitHub Releases `yellow-hammer/onec-debug-adapter` по версии из `package.json.onecDebugAdapter.version` (или `ONEC_DEBUG_ADAPTER_VERSION`);
  - если релиз недоступен — клонирует/обновляет соседний репозиторий `../onec-debug-adapter` и делает `dotnet publish` в `bin/onec-debug-adapter/`.
- После распаковки релиза временный архив `bin/onec-debug-adapter-*.zip` **удаляется**; в git он также игнорируется.
- Папка `scripts/` и любые вспомогательные скрипты **не должны** попадать в VSIX (`.vscodeignore` их исключает).

## Использование DAP в расширении

- Тип дебаггера в `package.json` — `1c-platform-tools`, программа: `./bin/onec-debug-adapter/OnecDebugAdapter.dll`, runtime: `dotnet`.
- В `src/debug/debugConfigurations.ts`:
  - базовый `platformPath` определяется как:
    - Windows: `${env:PROGRAMFILES}/1cv8`
    - Linux: `/opt/1C/v8.3/x86_64`;
  - `rootProject` при создании конфигурации строится из настройки `1c-platform-tools.paths.cf` (`paths.cf` → `${workspaceFolder}/<cfPath>`);
  - `extensions` при создании конфигурации строится из подкаталогов настройки `1c-platform-tools.paths.cfe` (`paths.cfe` → `${workspaceFolder}/<cfePath>/<ИмяКаталога>` для каждого каталога).

## Связь с env.json и VRunner

- Для отладки DAP использует строку подключения к ИБ из `env.json`:
  - в `default["--ibconnection"]` должна быть строка `/F...` или `/S...`;
  - в `resolveDebugConfiguration` строка валидируется, и для `/F` путь нормализуется относительно `workspaceFolder`.
- Настройки путей (`1c-platform-tools.paths.cf`, `paths.cfe`, `paths.out`, `paths.dist` и др.) должны быть согласованы:
  - VRunner (`VRunnerManager`) использует их для сборки и выгрузки конфигурации/расширений;
  - DAP ожидает, что `rootProject` и `extensions` указывают на те же выгрузки, которые использует VRunner.

